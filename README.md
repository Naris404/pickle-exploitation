# pickle-exploitation
Short turoial about - Why using pickle library in python is a terrible idea.
### Introduction
Today I want to introduce you a python library named [pickle](https://docs.python.org/3/library/pickle.html). It's created to serialization and deserialization. This repository as the name suggest is about pickle exploitation, so I really hope you'll enjoy it and learn something new. And now we can start.
### 1. What is serialization and deserialization
Serialization is process of converting objects into stram of bytes that can be stored in persistance storage on local machine or transmitted over the network. Deserialization is just reversing process of serialization.
### 2. Pickle serialization
In pickle process of serialization and deserialization is named *pickling* and *unpickling*. You can pickle data using dumps() function and unpickle using loads() function. That's pretty much everything you have to know for now to understand. If you want to see entire process of pickle serialization and syscalls, you can use pickletools library and dis() function. Below is an example of serializing simple list and disasseambly code of this process.

      import pickle
  	from pickletools import dis
  	s = pickle.dumps([1,2,3]) # serialization process
  	dis(s)
    
###3. \_\_reduce\_\_()
In simple words when pickle don't know how to serialize an object (eg. file handles) we can use for that purpose \_\_reduce\_\_() method. First returning item has to be a function and second argument of this method has to be an argument of function that we specified in first argument, also it has to be a tuple. Below is an example of serialize file descriptor with and without \_\_reduce\_\_().

	import pickle

	class WithoutReduce:
		def __init__(self):
			self.f = open("test.txt")

	class WithReduce:
		def __init__(self):
			self._file_name = "test.txt"
		def __reduce__(self):
			return (open, (self._file_name,)) # returning file descriptor

	s = pickle.dumps(WithReduce()) # serialization process
	#s = pickle.dumps(WithouthReduce()) #throwing exception, see reduce.txt

	d = pickle.loads(s) # deserialization process, returning the file descriptor

	for i in d: # iterating over a file to prove everything went correct
		print(i.strip())
    
Above code' output:

    a
	b
	c
    
When we try to remove hash character in 14th line:

	Traceback (most recent call last):
	 File "C:\pickle\pickle_reduce.py", line 14, in <module>
		s = pickle.dumps(WithouthReduce())
	TypeError: cannot pickle '_io.TextIOWrapper' object
    

###4. Exploitation
Most important while using pickle is that to not unpickle data you don't trust (eg. inputed ny user), even in the official documentation there is note about that:
![](pickle_warning.jpg)
Despite of warnings many people are using that even nowdays in their projects, so please don't make that mistake and now we can move on.
Let's assume that we have a user and server that use pickle library and unpickle data that comes from user. In below code we can see RCE class that has \_\_reduce\_\_() method. As a first argument we use sysyem function from os library that let us execute system commands. In second argument is argument of that os.system function - command. In our case it's just "whoami" but hacker isn't gonna be so nice. We're not forgetting that it has to be a tuple. At the end we pickle our object and done, we have a payload. Execute it on your computer and try if it works :).
import pickle,os

	class Exploit():
		def __reduce__(self):
			return os.system,("whoami",)

	s = pickle.dumps(Exploit()) # serialization process, creating our payload

	pickle.loads(s) # deserialization on the server, moment of exploitation
    
